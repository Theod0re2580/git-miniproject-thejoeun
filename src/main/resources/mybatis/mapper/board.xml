<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jang.gitminiprojectthejoeun.dao.BoardDao">

    <!-- 게시글 작성 -->
    <insert id="writeBoard" parameterType="BoardDto">
        INSERT INTO board (id, member_id, title, content, secret_flag, regdate, hit)
        VALUES (board_seq.NEXTVAL, #{memberId}, #{title}, #{content}, #{secretFlag}, SYSDATE, 0)
    </insert>

    <!-- 게시글 전체 조회 -->
    <select id="findAll" parameterType="PageDto" resultType="BoardDto">
        SELECT b.id,
        b.title,
        b.content,
        b.regdate,
        b.hit,
        m.username AS writer
        FROM board b
        JOIN member m ON b.member_id = m.id
        <where>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="type == 'title'">
                        AND LOWER(b.title) LIKE '%' || LOWER(#{keyword}) || '%'
                    </when>
                    <when test="type == 'content'">
                        AND LOWER(b.content) LIKE '%' || LOWER(#{keyword}) || '%'
                    </when>
                    <when test="type == 'writer'">
                        AND LOWER(m.username) LIKE '%' || LOWER(#{keyword}) || '%'
                    </when>
                    <when test="type == 'all' or type == null or type == ''">
                        AND (
                        LOWER(b.title) LIKE '%' || LOWER(#{keyword}) || '%'
                        OR LOWER(b.content) LIKE '%' || LOWER(#{keyword}) || '%'
                        OR LOWER(m.username) LIKE '%' || LOWER(#{keyword}) || '%'
                        )
                    </when>
                </choose>
            </if>
        </where>
        ORDER BY b.id DESC
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>

    <!-- 게시글 상세 조회 -->
    <select id="findById" resultType="BoardDto" parameterType="int">
        SELECT b.id,
        b.member_id,
        m.username AS writer,
        b.title,
        b.content,
        b.regdate,
        b.hit,
        b.secret_flag
        FROM board b
        JOIN member m ON b.member_id = m.id
        WHERE b.id = #{id}
    </select>

    <!-- 게시글 삭제 (member.userpw 확인 방식) -->
    <!-- 글쓴이 본인만 삭제 가능 -->
    <delete id="deleteBoard" parameterType="BoardDto">
        <![CDATA[
        DELETE FROM board
        WHERE id = #{id}
          AND member_id = (
              SELECT m.id
              FROM member m
              WHERE m.userid = #{writer}
                AND m.userpw = #{password}
          )
    ]]>
    </delete>

    <update id="updateBoard" parameterType="BoardDto">
        <![CDATA[
    UPDATE board
       SET title = #{title},
           content = #{content},
           regdate = SYSDATE
     WHERE id = #{id}
       AND member_id = #{memberId}
    ]]>
    </update>

    <select id="totalBoard" parameterType="PageDto" resultType="int">
        SELECT COUNT(*)
        FROM board b
        JOIN member m ON b.member_id = m.id
        <where>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="type == 'title'">
                        AND LOWER(b.title) LIKE '%' || LOWER(#{keyword}) || '%'
                    </when>
                    <when test="type == 'content'">
                        AND LOWER(b.content) LIKE '%' || LOWER(#{keyword}) || '%'
                    </when>
                    <when test="type == 'writer'">
                        AND LOWER(m.username) LIKE '%' || LOWER(#{keyword}) || '%'
                    </when>
                    <when test="type == 'all' or type == null or type == ''">
                        AND (
                        LOWER(b.title) LIKE '%' || LOWER(#{keyword}) || '%'
                        OR LOWER(b.content) LIKE '%' || LOWER(#{keyword}) || '%'
                        OR LOWER(m.username) LIKE '%' || LOWER(#{keyword}) || '%'
                        )
                    </when>
                </choose>
            </if>
        </where>
    </select>


    <!-- ✅ 이전 글 -->
    <select id="findPrev" parameterType="int" resultType="BoardDto">
        <![CDATA[
            SELECT *
            FROM (
            SELECT b.id,
            b.title,
            b.content,
            b.regdate,
            b.hit,
            b.member_id,
            m.username AS writer
            FROM board b
            JOIN member m ON b.member_id = m.id
            WHERE b.id < #{id}
            ORDER BY b.id DESC
            )
            WHERE ROWNUM = 1
        ]]>

    </select>

    <!-- ✅ 다음 글 -->
    <select id="findNext" parameterType="int" resultType="BoardDto">
        <![CDATA[
            SELECT *
            FROM (
            SELECT b.id,
            b.title,
            b.content,
            b.regdate,
            b.hit,
            b.member_id,
            m.username AS writer
            FROM board b
            JOIN member m ON b.member_id = m.id
            WHERE b.id > #{id}
            ORDER BY b.id ASC
            )
            WHERE ROWNUM = 1
        ]]>
    </select>
</mapper>
