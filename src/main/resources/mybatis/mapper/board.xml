<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jang.gitminiprojectthejoeun.dao.BoardDao">

    <!-- 게시글 작성 -->
    <insert id="writeBoard" parameterType="BoardDto">
        INSERT INTO board (id, member_id, title, content, secret_flag, regdate, hit)
        VALUES (board_seq.NEXTVAL, #{memberId}, #{title}, #{content}, #{secretFlag}, SYSDATE, 0)
    </insert>

    <!-- 게시글 전체 조회 -->
    <select id="findAll" resultType="BoardDto" parameterType="PageDto">
        SELECT b.id,
        b.title,
        b.content,
        b.regdate,
        b.hit,
        m.username AS writer
        FROM board b
        JOIN member m ON b.member_id = m.id
        ORDER BY b.id DESC
        OFFSET ( (#{page} - 1) * #{size} ) ROWS FETCH NEXT #{size} ROWS ONLY
    </select>

    <!-- 게시글 상세 조회 -->
    <select id="findById" resultType="BoardDto" parameterType="int">
        SELECT b.id,
        b.member_id,
        m.username AS writer,
        b.title,
        b.content,
        b.regdate,
        b.hit,
        b.secret_flag
        FROM board b
        JOIN member m ON b.member_id = m.id
        WHERE b.id = #{id}
    </select>

    <!-- 게시글 삭제 (member.userpw 확인 방식) -->
    <delete id="deleteBoard" parameterType="BoardDto">
        <![CDATA[
        DELETE FROM board
        WHERE id = #{id}
          AND member_id = (
              SELECT m.id
              FROM member m
              WHERE m.id = board.member_id
              AND m.userpw = #{password}
          )
    ]]>
    </delete>

    <update id="updateBoard" parameterType="BoardDto">
        <![CDATA[
        UPDATE board
        SET title = #{title},
            content = #{content},
            regdate = SYSDATE
        WHERE id = #{id}
    ]]>
    </update>

    <!-- 전체 게시물 수 -->
    <select id="totalBoard" parameterType="PageDto" resultType="int">
        SELECT COUNT(*) AS total FROM board
    </select>

    <select id="findPrev" parameterType="int" resultType="BoardDto">
        <![CDATA[
        SELECT * FROM (
            SELECT * FROM board WHERE id < #{id} ORDER BY id DESC
        ) WHERE ROWNUM = 1
    ]]>
    </select>

    <select id="findNext" parameterType="int" resultType="BoardDto">
        <![CDATA[
        SELECT * FROM (
            SELECT * FROM board WHERE id > #{id} ORDER BY id ASC
        ) WHERE ROWNUM = 1
    ]]>
    </select>

</mapper>
