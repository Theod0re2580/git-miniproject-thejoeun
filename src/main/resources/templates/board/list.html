<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head::head('게시판 리스트')}"></head>
<link rel="stylesheet" th:href="@{/css/list.css}">
<body class="flex flex-col min-h-screen bg-base-100">
<header th:replace="~{fragments/header}"></header>

<main class="flex-grow pt-12 pb-28">

    <!-- ✅ 게시판 테이블 -->
    <div class="board-wrap">
        <th:block th:if="${!boardList.isEmpty()}">
            <table class="board-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>제목</th>
                    <th>글쓴이</th>
                    <th>날짜</th>
                    <th>조회수</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${boardList}">
                    <td th:text="${item.id}"></td>
                    <td>
                        <!-- ✅ 공개글 -->
                        <a th:if="${item.secretFlag == 0}"
                           th:href="@{/board/{id}/detail(id=${item.id})}"
                           th:text="${item.title}"></a>

                        <!-- ✅ 비밀글 -->
                        <a th:if="${item.secretFlag == 1}"
                           href="#"
                           th:attr="data-id=${item.id}, data-writer=${item.writer}, data-title=${item.title}"
                           th:text="${item.title}"
                           onclick="checkSecretPost(this)"></a>
                        <span th:if="${item.secretFlag == 1}" class="text-error ml-1">🔒</span>
                    </td>
                    <td th:text="${item.writer}"></td>
                    <td>
                        <span class="date-box" th:text="${#temporals.format(item.regdate, 'yyyy-MM-dd')}"></span>
                    </td>
                    <td th:text="${item.hit}"></td>
                </tr>
                </tbody>
            </table>

            <!-- ✅ 페이지네이션 -->
            <nav class="my-10 flex justify-center">
                <div class="join">
                    <a class="join-item btn"
                       th:href="@{/board/list(page=${responsePageDto.page - 1}, size=${responsePageDto.size}, keyword=${responsePageDto.keyword}, type=${responsePageDto.type})}"
                       th:classappend="${!responsePageDto.hasPrev} ? 'btn-disabled'">이전</a>

                    <th:block th:each="num : ${#numbers.sequence(responsePageDto.getStartPage(5), responsePageDto.getEndPage(5))}">
                        <a class="join-item btn"
                           th:text="${num}"
                           th:href="@{/board/list(page=${num}, size=${responsePageDto.size}, keyword=${responsePageDto.keyword}, type=${responsePageDto.type})}"
                           th:classappend="${num == responsePageDto.page} ? 'btn-primary'"></a>
                    </th:block>

                    <a class="join-item btn"
                       th:href="@{/board/list(page=${responsePageDto.page + 1}, size=${responsePageDto.size}, keyword=${responsePageDto.keyword}, type=${responsePageDto.type})}"
                       th:classappend="${!responsePageDto.hasNext} ? 'btn-disabled'">다음</a>
                </div>
            </nav>
        </th:block>

        <!-- ✅ 게시글이 없을 경우 -->
        <th:block th:if="${boardList.isEmpty()}">
            <div class="my-10 text-4xl font-bold text-center">등록된 게시글이 없습니다.</div>
        </th:block>
    </div>

    <!-- ✅ 검색 영역 -->
    <form th:action="@{/board/list}" method="get"
          class="flex flex-wrap items-center justify-center gap-3 mt-10">
        <select class="select select-bordered w-32" name="type">
            <option th:value="writer"  th:selected="${responsePageDto.type=='writer'}">글쓴이</option>
            <option th:value="title"   th:selected="${responsePageDto.type=='title'}">제목</option>
            <option th:value="content" th:selected="${responsePageDto.type=='content'}">내용</option>
            <option th:value="all"     th:selected="${responsePageDto.type=='all'}">전체</option>
        </select>

        <input type="text" name="keyword"
               th:value="${param.keyword}"
               placeholder="검색어를 입력하세요"
               class="input input-bordered w-64"/>

        <button class="btn btn-primary" type="submit">검색</button>
    </form>

    <!-- ✅ 로그인 사용자만 글쓰기 버튼 표시 -->
    <div class="mt-10 text-center" th:if="${session.loggedMember != null}">
        <a th:href="@{/board/write}" class="btn btn-primary">글쓰기</a>
    </div>

    <!-- ✅ 비밀번호 입력 모달 -->
    <div id="pwModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-5 rounded-lg shadow-lg w-80 text-center">
            <p class="font-bold mb-3">비밀글 비밀번호를 입력하세요 🔐</p>
            <input type="password" id="secretPwInput" placeholder="비밀번호 입력"
                   class="input input-bordered w-full mb-3"/>
            <div class="flex justify-center gap-3">
                <button id="confirmBtn" class="btn btn-primary w-24" onclick="validateSecretPw()">확인</button>
                <button type="button" class="btn w-24" onclick="closePwModal()">취소</button>
            </div>
        </div>
    </div>

</main>

<footer th:replace="~{fragments/footer::footer-sns}"></footer>

<script th:inline="javascript">
    const msg = /*[[${msg}]]*/ null;
    if (msg) alert(msg);
</script>

<script>
    let selectedPostId = null;

    function checkSecretPost(link) {
        // 제목 클릭 시 id 저장 + 모달 오픈
        selectedPostId = link.dataset.id; // data-id에서 꺼냄
        const modal = document.getElementById("pwModal");
        modal.classList.remove("hidden");
        document.getElementById("secretPwInput").value = "";
        document.getElementById("secretPwInput").focus();
    }

    function closePwModal() {
        document.getElementById("pwModal").classList.add("hidden");
    }

    // ✅ 비밀번호 검증 호출 (확인 버튼에서 호출)
    async function validateSecretPw() {
        const pw = document.getElementById("secretPwInput").value.trim();
        if (!selectedPostId) {
            alert("게시글을 다시 선택해주세요.");
            return;
        }
        if (!pw) {
            alert("비밀번호를 입력하세요.");
            return;
        }

        try {
            const res = await fetch(`/board/checkSecretPw?id=${selectedPostId}&secretPw=${encodeURIComponent(pw)}`, {
                method: "GET",
                headers: { "Accept": "text/plain" }
            });
            const text = await res.text();
            if (text === "OK") {
                // 성공 → 상세로 이동
                window.location.href = `/board/${selectedPostId}/detail`;
            } else {
                alert("비밀번호가 일치하지 않습니다.");
                document.getElementById("secretPwInput").focus();
            }
        } catch (e) {
            console.error(e);
            alert("검증 중 오류가 발생했습니다.");
        }
    }

    // Enter로도 확인
    document.addEventListener("DOMContentLoaded", () => {
        const input = document.getElementById("secretPwInput");
        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                validateSecretPw();
            }
        });
    });
</script>

</body>
</html>
