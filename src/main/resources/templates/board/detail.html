<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head::head('ê¸€ë³´ê¸°')}"></head>
<link rel="stylesheet" th:href="@{/css/detail.css}">
<body class="flex flex-col min-h-screen bg-base-100">
<header th:replace="~{fragments/header}"></header>

<main>
    <div class="detail-container">
        <h1>ê²Œì‹œê¸€ ìƒì„¸</h1>

        <!-- âœ… ê²Œì‹œê¸€ ë‚´ìš© -->
        <table class="detail-table">
            <tbody>
            <tr><th>ì œëª©</th><td th:text="${boardDto.title}"></td></tr>
            <tr><th>ê¸€ì“´ì´</th><td th:text="${boardDto.writer}"></td></tr>
            <tr><th>ë‚´ìš©</th><td th:text="${boardDto.content}" class="whitespace-pre-line"></td></tr>
            <tr><th>ì¡°íšŒìˆ˜</th><td th:text="${boardDto.hit}"></td></tr>
            <tr><th>ë‚ ì§œ</th><td th:text="${#temporals.format(boardDto.regdate,'yyyy-MM-dd HH:mm')}"></td></tr>
            </tbody>
        </table>

        <!-- âœ… ìˆ˜ì • / ì‚­ì œ ë²„íŠ¼ (ì‘ì„±ì ì „ìš©) -->
        <div class="detail-actions"
             th:if="${session.loggedMember != null and session.loggedMember.userName == boardDto.writer}">
            <a th:href="@{/board/{id}/update(id=${boardDto.id})}" class="btn btn-primary">ìˆ˜ì •</a>
            <button id="btn-delete" class="btn btn-error">ì‚­ì œ</button>
        </div>

        <!-- âœ… ì´ì „ê¸€ / ë‹¤ìŒê¸€ ì˜ì—­ -->
        <div class="nav-buttons mt-10 space-y-3">
            <div th:if="${prevBoardDto != null}">
                <!-- ê³µê°œê¸€ -->
                <a th:if="${prevBoardDto.secretFlag == 0}"
                   th:href="@{/board/{id}/detail(id=${prevBoardDto.id})}">
                    â† ì´ì „ê¸€: <span th:text="${prevBoardDto.title}"></span>
                </a>

                <!-- ë¹„ë°€ê¸€ -->
                <a th:if="${prevBoardDto.secretFlag == 1}"
                   href="#"
                   th:data-id="${prevBoardDto.id}"
                   th:text="'â† ì´ì „ê¸€: ' + ${prevBoardDto.title}"
                   class="secret-link text-error"></a>
            </div>

            <div th:if="${nextBoardDto != null}">
                <!-- ê³µê°œê¸€ -->
                <a th:if="${nextBoardDto.secretFlag == 0}"
                   th:href="@{/board/{id}/detail(id=${nextBoardDto.id})}">
                    ë‹¤ìŒê¸€: <span th:text="${nextBoardDto.title}"></span> â†’
                </a>

                <!-- ë¹„ë°€ê¸€ -->
                <a th:if="${nextBoardDto.secretFlag == 1}"
                   href="#"
                   th:data-id="${nextBoardDto.id}"
                   th:text="'ë‹¤ìŒê¸€: ' + ${nextBoardDto.title} + ' â†’'"
                   class="secret-link text-error"></a>
            </div>
        </div>
    </div>

    <!-- âœ… ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="pwModal"
         class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-5 rounded-lg shadow-lg w-80 text-center">
            <p class="font-bold mb-3">ë¹„ë°€ê¸€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” ğŸ”</p>
            <input type="password" id="secretPwInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
                   class="input input-bordered w-full mb-3"/>
            <div class="flex justify-center gap-3">
                <button id="confirmBtn" class="btn btn-primary w-24" onclick="validateSecretPw()">í™•ì¸</button>
                <button type="button" class="btn w-24" onclick="closePwModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/footer::footer-sns}"></footer>

<!-- âœ… ê²Œì‹œê¸€ ì‚­ì œ JS (ê¸°ì¡´ ì½”ë“œ ìœ ì§€) -->
<script th:inline="javascript">
    document.getElementById("btn-delete")?.addEventListener("click", async () => {
        if (!confirm("ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ğŸ—‘ï¸")) return;

        const boardId = /*[[${boardDto.id}]]*/ 0;

        try {
            const response = await fetch("/board/delete", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ id: boardId }),
            });

            const result = await response.json();

            if (result.success) {
                alert(result.message);
                window.location.href = "/board/list";
            } else {
                alert(result.message || "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        } catch (err) {
            console.error(err);
            alert("ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ âŒ");
        }
    });
</script>

<!-- âœ… ë¹„ë°€ê¸€ ê²€ì¦ ê¸°ëŠ¥ (ì´ì „ê¸€/ë‹¤ìŒê¸€ìš©) -->
<script>
    let selectedPostId = null;

    // ë¹„ë°€ê¸€ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".secret-link").forEach(link => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                selectedPostId = link.dataset.id;
                const modal = document.getElementById("pwModal");
                modal.classList.remove("hidden");
                const input = document.getElementById("secretPwInput");
                input.value = "";
                input.focus();
            });
        });

        // Enter í‚¤ë¡œ í™•ì¸
        const pwInput = document.getElementById("secretPwInput");
        pwInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                validateSecretPw();
            }
        });
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    function closePwModal() {
        document.getElementById("pwModal").classList.add("hidden");
    }

    // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
    async function validateSecretPw() {
        const pw = document.getElementById("secretPwInput").value.trim();
        if (!selectedPostId) {
            alert("ê²Œì‹œê¸€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        if (!pw) {
            alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        try {
            const res = await fetch(`/board/checkSecretPw?id=${selectedPostId}&secretPw=${encodeURIComponent(pw)}`);
            const result = await res.text();
            if (result === "OK") {
                closePwModal();
                window.location.href = `/board/${selectedPostId}/detail`;
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ âŒ");
                document.getElementById("secretPwInput").focus();
            }
        } catch (err) {
            console.error(err);
            alert("ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }
</script>

</body>
</html>
