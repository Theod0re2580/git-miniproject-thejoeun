<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head::head('마이페이지')}"></head>
<link rel="stylesheet" th:href="@{/css/info.css}">
<body class="flex flex-col min-h-screen bg-base-100">
<header th:replace="~{fragments/header}"></header>

<main class="flex-grow pt-24 pb-28">
    <div id="section">

        <!-- 🔹 상단 회원 인사 -->
        <div class="my_top">
            <div class="top_left">
                <p>안녕하세요. <span th:text="${member.userName}"></span>님</p>
            </div>
            <div class="top_right">
                <div class="point">
                    <p class="label">가입일</p>
                    <p class="value" th:text="${#temporals.format(member.regdate, 'yyyy-MM-dd')}"></p>
                </div>
            </div>
        </div>

        <!-- 🔹 본문 전체 구조 -->
        <div class="my_body">
            <!-- 왼쪽 메뉴 -->
            <div class="my_sidebar">
                <h2>마이페이지</h2>
                <ul>
                    <li class="active">내 정보 보기</li>
                    <li>내가 쓴 글</li>
                </ul>
            </div>

            <!-- 오른쪽 콘텐츠 -->
            <div class="my_content">

                <!-- ✅ 회원 정보 -->
                <div class="content" id="info-content" style="display:block;">
                    <h3>회원 정보</h3>
                    <table class="personal_info">
                        <tr><td>아이디</td><td th:text="${member.userID}"></td></tr>
                        <tr><td>이름</td><td th:text="${member.userName}"></td></tr>
                        <tr><td>이메일</td><td th:text="${member.userEmail}"></td></tr>
                        <tr><td>가입일</td><td th:text="${#temporals.format(member.regdate, 'yyyy-MM-dd')}"></td></tr>
                    </table>

                    <div class="cus_btn">
                        <a th:href="@{/member/update}" class="cus_edit auth-required">회원정보 수정</a>
                        <a th:href="@{/member/delete}" class="cus_edit delete auth-required">회원탈퇴</a>
                    </div>
                </div>

                <!-- ✅ 내가 쓴 글 -->
                <div class="content" id="post-content" style="display:none;">
                    <h3>내가 쓴 글 ✏️</h3>
                    <div th:if="${#lists.isEmpty(myBoardList)}" class="text-gray-500 text-center py-10">
                        작성한 게시글이 없습니다.
                    </div>

                    <div th:unless="${#lists.isEmpty(myBoardList)}">
                        <table class="order_table">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>제목</th>
                                <th>작성일</th>
                                <th>조회수</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="post : ${myBoardList}">
                                <td th:text="${post.id}"></td>
                                <td>
                                    <a th:href="@{/board/{id}/detail(id=${post.id})}" th:text="${post.title}" class="link link-hover font-medium"></a>
                                    <span th:if="${post.secretFlag == 1}" class="text-error ml-1">🔒</span>
                                </td>
                                <td th:text="${#temporals.format(post.regdate, 'yyyy-MM-dd')}"></td>
                                <td th:text="${post.hit}"></td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- ✅ 페이지네이션 -->
                        <div class="page_btn">
                            <a th:href="@{/member/info(page=${responsePageDto.page - 1}, size=${responsePageDto.size}, tab='posts')}"
                               th:classappend="${!responsePageDto.hasPrev} ? 'btn-disabled'">이전</a>

                            <th:block th:each="num : ${#numbers.sequence(responsePageDto.getStartPage(5), responsePageDto.getEndPage(5))}">
                                <a th:text="${num}"
                                   th:href="@{/member/info(page=${num}, size=${responsePageDto.size}, tab='posts')}"
                                   th:classappend="${num == responsePageDto.page} ? 'btn-primary'"></a>
                            </th:block>

                            <a th:href="@{/member/info(page=${responsePageDto.page + 1}, size=${responsePageDto.size}, tab='posts')}"
                               th:classappend="${!responsePageDto.hasNext} ? 'btn-disabled'">다음</a>
                        </div>
                    </div>
                </div>

                <!-- ✅ 하단 버튼 -->
                <div class="l_btn">
                    <button class="l_btnn"><a th:href="@{/board/list}">게시판으로 이동</a></button>
                    <button class="l_btnn"><a th:href="@{/member/logout}">로그아웃</a></button>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/footer}"></footer>

<!-- ✅ 탭 전환 스크립트 -->
<script>
    const menuItems = document.querySelectorAll('.my_sidebar li');
    const contents = document.querySelectorAll('.my_content .content');

    // 메뉴 클릭 시 탭 변경
    menuItems.forEach((item, index) => {
        item.addEventListener('click', () => {
            menuItems.forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            contents.forEach(c => c.style.display = 'none');
            contents[index].style.display = 'block';
        });
    });

    // ✅ URL 파라미터로 탭 자동 전환
    const params = new URLSearchParams(window.location.search);
    const tab = params.get("tab");
    if (tab === "posts") {
        menuItems.forEach(i => i.classList.remove('active'));
        contents.forEach(c => c.style.display = 'none');
        menuItems[1].classList.add('active');
        contents[1].style.display = 'block';
    }
</script>

<!-- ✅ 로그인 확인 -->
<script th:inline="javascript">
    const isLoggedIn = /*[[${session.loggedMember != null}]]*/ false;

    document.querySelectorAll(".auth-required").forEach(btn => {
        btn.addEventListener("click", e => {
            if (!isLoggedIn) {
                e.preventDefault();
                alert("로그인이 필요한 서비스입니다.");
                window.location.href = "/member/login";
            }
        });
    });

    /*<![CDATA[*/
    const msg = /*[[${msg}]]*/ null;
    if (msg) {
        alert(msg);
    }
    /*]]>*/
</script>
</body>
</html>
